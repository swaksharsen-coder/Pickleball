<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pickleball 2v2 Player Ratings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial; background:#f4f4f4; margin:0; padding:0; }
    .container { max-width:1100px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.12); }
    h1,h2 { text-align:center; }
    .tabs { display:flex; justify-content:center; gap:10px; margin-bottom:15px; }
    .tab-button { padding:8px 14px; border-radius:20px; border:1px solid #007bff; cursor:pointer; }
    .tab-button.active { background:#007bff; color:#fff; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .flex { display:flex; flex-wrap:wrap; gap:20px; }
    .card { flex:1 1 300px; background:#fafafa; padding:15px; border-radius:8px; }
    label { font-weight:bold; font-size:0.9rem; }
    input,select,button { width:100%; padding:7px; margin-bottom:10px; }
    button { background:#007bff; color:white; border:none; font-weight:bold; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border-bottom:1px solid #ddd; padding:6px; text-align:center; }
    th { background:#eee; }
    .admin-only { display:none; }
  </style>
</head>
<body>
<div class="container">
<h1>Pickleball 2v2 Player Ratings</h1>

<div class="tabs">
  <button class="tab-button active" data-tab="matches">Matches</button>
  <button class="tab-button" data-tab="players">Players</button>
  <button class="tab-button" data-tab="stats">Stats</button>
  <button class="tab-button" data-tab="admin">Admin</button>
</div>

<!-- MATCHES TAB -->
<div id="tab-matches" class="tab-content active">
  <div class="flex">
    <div class="card">
      <h2>Record Match</h2>
      <label>Team A</label>
      <select id="teamA1"></select>
      <select id="teamA2"></select>

      <label>Team B</label>
      <select id="teamB1"></select>
      <select id="teamB2"></select>

      <label>Score Team A</label><input id="scoreA" type="number">
      <label>Score Team B</label><input id="scoreB" type="number">

      <button id="recordBtn" class="admin-only">Record Match</button>
      <div id="matchMsg"></div>
    </div>

    <div class="card">
      <h2>Leaderboard</h2>
      <table><thead>
        <tr><th>Rank</th><th>Name</th><th>Rating</th><th>W</th><th>L</th></tr>
      </thead><tbody id="leaderboard"></tbody></table>
    </div>
  </div>
</div>

<!-- PLAYERS TAB -->
<div id="tab-players" class="tab-content">
  <h2>Players</h2>
  <ul id="playerList"></ul>
</div>

<!-- STATS TAB -->
<div id="tab-stats" class="tab-content">
  <h2>Player Stats</h2>
  <select id="statsPlayer"></select>
  <button id="loadStats">Load Stats</button>
  <div id="statsOut"></div>
  <table><thead><tr><th>Date</th><th>Result</th><th>Score</th><th>Rating After</th></tr></thead>
  <tbody id="statsTable"></tbody></table>
</div>

<!-- ADMIN TAB -->
<div id="tab-admin" class="tab-content">
  <div class="flex">
    <div class="card">
      <label>Email</label><input id="loginEmail">
      <label>Password</label><input id="loginPass" type="password">
      <button id="loginBtn">Login</button>
    </div>

    <div class="card admin-only">
      <input id="newPlayer" placeholder="Player Name">
      <button id="addPlayer">Add Player</button>
    </div>
  </div>
</div>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxH9Zda7Yx31CN3jimkUZkuDEg4ecaqQ8",
  authDomain: "pickleball-elo.firebaseapp.com",
  projectId: "pickleball-elo",
  storageBucket: "pickleball-elo.firebasestorage.app",
  messagingSenderId: "115251632176",
  appId: "1:115251632176:web:20c5cd2a72ad37c44bf5f5"
};

const MASTER_ADMIN_EMAIL = "swaksharsen@gmail.com";

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let isAdmin=false;
let players=[];

auth.onAuthStateChanged(u=>{
  isAdmin = u && u.email===MASTER_ADMIN_EMAIL;
  document.querySelectorAll(".admin-only").forEach(e=>e.style.display=isAdmin?"block":"none");
});

// TAB SWITCHING
document.querySelectorAll(".tab-button").forEach(b=>{
  b.onclick=()=> {
    document.querySelectorAll(".tab-button").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.getElementById("tab-"+b.dataset.tab).classList.add("active");
  }
});

// LOGIN
loginBtn.onclick=()=> auth.signInWithEmailAndPassword(loginEmail.value, loginPass.value);

// ADD PLAYER
addPlayer.onclick=()=> db.collection("players").add({name:newPlayer.value,rating:1500,wins:0,losses:0});

// LOAD PLAYERS
db.collection("players").onSnapshot(s=>{
  players=[]; leaderboard.innerHTML=""; playerList.innerHTML=""; statsPlayer.innerHTML="";
  s.forEach((d,i)=>{
    let p={id:d.id,...d.data()}; players.push(p);
    leaderboard.innerHTML+=`<tr><td>${i+1}</td><td>${p.name}</td><td>${p.rating}</td><td>${p.wins}</td><td>${p.losses}</td></tr>`;
    playerList.innerHTML+=`<li>${p.name}</li>`;
    ["teamA1","teamA2","teamB1","teamB2","statsPlayer"].forEach(id=>{
      document.getElementById(id).innerHTML+=`<option value="${p.id}">${p.name}</option>`;
    });
  });
});

// RECORD MATCH
recordBtn.onclick=()=>{
  let A=[teamA1.value,teamA2.value], B=[teamB1.value,teamB2.value];
  let sA=+scoreA.value, sB=+scoreB.value;
  let AW = sA>sB;
  A.concat(B).forEach(id=>{
    let p=players.find(x=>x.id===id);
    let win = (A.includes(id)&&AW)||(B.includes(id)&&!AW);
    db.collection("players").doc(id).update({
      rating:p.rating+(win?20:-10),
      wins:p.wins+(win?1:0),
      losses:p.losses+(win?0:1)
    });
  });
};

// STATS
loadStats.onclick=async()=>{
const pid=statsPlayer.value;
statsOut.innerHTML=""; statsTable.innerHTML="";
let q1=await db.collection("matches").where("teamA","array-contains",pid).get();
let q2=await db.collection("matches").where("teamB","array-contains",pid).get();
q1.docs.concat(q2.docs).forEach(d=>{
  let m=d.data();
  let r = (m.teamA.includes(pid)&&m.winner==="A") || (m.teamB.includes(pid)&&m.winner==="B");
  statsTable.innerHTML+=`<tr><td>${new Date(m.timestamp.seconds*1000).toLocaleString()}</td><td>${r?"Win":"Loss"}</td><td>${m.scoreA}-${m.scoreB}</td><td>${m.playerRatings[pid].after}</td></tr>`;
});
};
</script>
</body>
</html>
